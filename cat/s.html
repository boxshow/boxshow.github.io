<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<title>获取文件</title>
</head>
<body>
<style>
body{text-align: center;margin: 0;font-size: 16px;background-color:#efeff4;}#pmsg{margin: 0;color: #222;padding: 70px 50px 20px;text-align: center;display: none;}.topinfo{background: #08f;color: #fff;width: 80px;margin: auto;margin-bottom: 10px;height: 80px;border-radius: 50%;line-height: 80px;font-size: 50px;}.fmsg{font-size: 18px;font-weight: bold;color: #03081A;letter-spacing: 2px;}.furl{padding: 15px 0;word-break: break-all;font-size: 14px;color: #03081A;}.fbox{font-size: 16px;margin-bottom: 13px;font-weight: normal;color: #878B99;}.btn{width: 100%;margin: 13px auto 0;padding: 15px 0;font-size: 16px;text-align: center;background: #08f;color: #fff;outline: none;border: none;}#trip{background: #333;color: #fff;margin: auto;position: absolute;right: 0px;left: 0px;top: 10px;padding: 5px;display: none;}

input{outline-color:invert;outline-style:none;outline-width:0px;border:none;border-style:none;text-shadow:none;-webkit-user-select:text;outline-color:transparent;box-shadow:none}.reg{margin:10px auto;width:220px}.reg div{text-align:center;line-height:20px;font-size:18px;margin:15px 0}.reg .itxt{font-size:18px;width:193px;height:50px;border:1px solid#bbb;line-height:48px;padding-left:25px;color:#666;margin-bottom:10px}.reg .itxt:hover{border:1px solid#888}.reg .itxt:focus{border:1px solid#08f}.reg .regbtn{width:220px;height:50px;font-size:18px;text-align:center;line-height:48px;color:#fff;background-color:#08f;cursor:pointer}.reg .username{background:url(./user.jpg)no-repeat 5px center}.reg .password{background:url(./pass.jpg)no-repeat 5px center}
#cmsg{padding:10px 5px 0;height:18px;line-height:18px;color:red;font-size:16px;text-align:center;display:none}
#sign{display:none}
</style>

<div id="trip"></div>
<div id="pmsg"></div>
<div id="cmsg"></div>

<div id="sign" class="reg">
	<form name="sign" action="javascript:form_submit(0);" method="post">
		<input name="n" type="text" class="itxt username" placeholder="手机 / QQ">
		<input name="p" type="password" class="itxt password" placeholder="密码">
		<input name="cp" type="password" class="itxt password" placeholder="确认密码">
		<input name="r" type="submit" class="regbtn" value="注册">
	</form>
</div>
	
<script src="./clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.btn', {
        text: function() {
            return window.location.href;
        }
    });
 
    clipboard.on('success', function(e) {
		document.getElementById('trip').innerText='复制成功，请打开浏览器，在地址栏粘贴访问';
		document.getElementById("trip").style.display="block";
    });
 
    clipboard.on('error', function(e) {
		document.getElementById('trip').innerText='复制失败，右上角三个点，再选择浏览器打开';
		document.getElementById("trip").style.display="block";
    });
</script>

<script src="./ws.js"></script>
<script src="./md.js"></script>
<script type="text/javascript">


function qs(name) {
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
	var r = window.location.search.substr(1).match(reg);
	if (r != null)
		return decodeURI(r[2]);
	return null;
}

function show_html(id,html='') {
	
	if(id==1){//注册
		document.getElementById('cmsg').innerText='';
		document.getElementById('cmsg').style.display='block';
		document.getElementById('sign').style.display='block';
		document.getElementById('pmsg').style.display='none';
		document.getElementById('pmsg').innerHTML=html;
	}else if(id==2){//信息
		document.getElementById('cmsg').style.display='none';
		document.getElementById('sign').style.display='none';
		document.getElementById('pmsg').innerHTML=html;
		document.getElementById('pmsg').style.display='block';
	}
}

var prom = qs('p');
var ua = navigator.userAgent.toLowerCase();
//var ws = new WebSocket('ws://47.97.26.16:3696');
//ws.onopen = function(event) {}; 
//ws.onclose = function(event) {}; 
//ws.onerror = function(event) {}; 
ws.onmessage = function(event) {
	//console.log(event.data);
	
	var data = JSON.parse(event.data);
	if(data.code<0){
		var text = data.text.split("@");
		//var html = '<div class="topinfo">!</div><div class="fmsg">'+text[0]+'</div><div class="furl"></div><div class="fbox">'+text[1]+'</div>';
		//show_html(2,html);
		document.getElementById('cmsg').innerText=text[1];
	}else{
		window.location.href=text[1];
	}

};

function form_submit(id) {
	var f = document.forms[id];
	if(!chack_form(f))return false;

	var user=f.n.value;
	var pass=hex_md5(user+f.p.value);
	//console.log(f.name);
	
	ws.send('{"form": "'+f.name+'", "user": "'+user+'", "pass": "'+pass+'", "prom": "'+prom+'"}');
}

function chack_form(f){
	var cmsg = document.getElementById('cmsg');
	
	if (f.n!=null && f.n.value==''){
		cmsg.innerText='还没填写账号';
		f.n.focus();
		return false;
	}
	if (!(/^1[3456789]\d{9}$/.test(f.n.value))){//不是手机号
		if (!(/^[1-9][0-9]{4,10}$/.test(f.n.value))){//不是企鹅号
			cmsg.innerText='账号格式不正确';
			f.n.select();
			return false;
		}
	}
	if (f.p!=null && f.p.value==''){
		cmsg.innerText='密码不能为空';
		f.p.focus();
		return false;
	}
	if (f.cp!=null && f.cp.value==''){
		cmsg.innerText='确认密码不能为空';
		f.cp.focus();
		return false;
	}
	if (f.cp!=null && f.cp.value!=f.p.value){
		cmsg.innerText='两次密码输入不一致';
		f.p.focus();
		return false;
	}
	return true;
}

if (ua.indexOf('micromessenger')==-1){
    show_html(1);
} else {
	var html = '<div class="topinfo">!</div><div class="fmsg">访问说明</div><div class="furl"></div><div class="fbox">请复制链接后使用非微信浏览器访问</div><button class="btn">点此复制链接</button>';
	show_html(2,html);
}


</script>

<div style="display: none;"></div>
</body>
</html>
